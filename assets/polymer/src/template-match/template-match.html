<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<link rel="import" href="/polymer/bower_components/polymer/polymer.html">
<link rel="import" href="/polymer/src/app-data.html">

<dom-module id="template-match">
    <template>
        <app-data key="viewTemplateOverrides" data="{{viewTemplateOverrides}}"></app-data>
        <app-data key="nodeData" data="{{nodeData}}"></app-data>
        <iron-ajax 
            id="getViewTemplateOverrides" 
            url="/content/getViewTemplateOverrides" 
            handle-as="json" 
            last-response="{{viewTemplateOverrides}}" 
            on-response="_updateViewTemplateOverrides" 
            debounce-duration="300">
        </iron-ajax>
        <div id="template"></div>
    </template>
    <script>
    (function() {
        'use strict';

        Polymer({
            is: 'template-match',

            properties: {
                overrides: {
                    type: Object,
                    value: function() {
                        return {};
                    },
                    notify: true
                },
                app: {
                    type: Object,
                    value: function() {
                        return {};
                    },
                    notify: true,
                    reflectToAttribute: true,
                    observer: '_appChanged'
                },
                viewTemplate: {
                    type: String,
                    value: 'content-full'
                }
            },

            observers: [
                '_identityNodeChanged(app.identityNode)'
            ],

            _identityNodeChanged: function() {
                // console.log('identityNode changed');
                //this.createElement();
            },

            _appChanged: function() {
                //console.log('app changed');
            },

            _updateViewTemplateOverrides: function() {
                //console.log('update this.viewTemplateOverrides: ');
                // this.app.viewTemplateOverrides = this.viewTemplateOverrides;
                //console.log(this.app.viewTemplateOverrides);
                this.createElement();
            },

            ready: function() {
                // Get view template overrides if they are not already in the app object
                if (!this.viewTemplateOverrides) {
                    //console.log('ready: no overrides, get them');
                    this.$.getViewTemplateOverrides.generateRequest();
                }
                this.currentViewTemplate = this.viewTemplate;
            },

            createElement: function() {
                //console.log('create Element starting');
                if (!this.viewTemplateOverrides) {
                    //console.log('createElement: no overrides, get them');
                    //console.log(this.viewTemplateOverrides);
                    this.$.getViewTemplateOverrides.generateRequest();
                    return;
                }
                if (!this.nodeData.identityNode) {
                    //console.log('createElement: no identityNode yet');
                    return;
                }
                var el,
                    viewTemplateOverride = '',
                    props = {};

                // Get the view template override, if there is one
                viewTemplateOverride = this.getViewTemplate();
                if(!viewTemplateOverride) {
                    viewTemplateOverride = this.viewTemplate;
                }
                // console.log('this.currentViewTemplate: ' + this.currentViewTemplate);
                // console.log('viewTemplateOverride: ' + viewTemplateOverride);

                if(this.currentViewTemplate !== viewTemplateOverride || !this.$.template.firstChild) {
                    // Remove the first child if there is one
                    if (this.$.template.firstChild) {
                        //console.log('Remove child: ' + this.$.template.firstChild);
                        this.$.template.removeChild(this.$.template.firstChild);
                    }
                    //console.log('creating child');
                    props['app'] = this.app;
                    props['identityNodeId'] = this.nodeData.identityNode.properties.uuid;
                    el = Polymer.Base.create(viewTemplateOverride, props);
                    this.$.template.appendChild(el);
                    this.currentViewTemplate = viewTemplateOverride;
                } else {
                    this.$.template.firstChild.notifyPath('app.identityNode');
                    this.$.template.firstChild.refresh();
                }
            },

            getViewTemplate: function() {
                var viewTemplate = this.viewTemplate,
                    overrides = this.viewTemplateOverrides;

                var viewTemplateOverride = "";
                for (var i = 0; i < overrides.length; i++) {
                    var source = overrides[i].Override.properties.source,
                        matchFile = overrides[i].Override.properties.matchFile,
                        contentTypeIdentifier = overrides[i].Override.properties.contentTypeIdentifier,
                        identityNodeId = overrides[i].Override.properties.identityNodeId;

                    if (viewTemplate === source) {
                        if (identityNodeId === this.nodeData.identityNode.properties.uuid ||
                            contentTypeIdentifier === this.nodeData.identityNode.properties.contentType) {
                            viewTemplateOverride = matchFile;
                        }
                    }
                };
                return viewTemplateOverride;
            }

        });
    })();
    </script>
</dom-module>
