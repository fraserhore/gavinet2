<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<link rel="import" href="/polymer/bower_components/polymer/polymer.html">
<link rel="import" href="../mxgraph-import/mxgraph-import.html">
<link rel="import" href="../mxgraph-change-handler.html">
<link rel="import" href="../api-gavi-graph.html">
<!-- <link rel="import" href="../api-sharepoint.html"> -->
<!-- <link rel="stylesheet" type="text/css" href="styles/grapheditor.css"> -->
<script type="text/javascript" src="js/Init.js"></script>
<!-- <script type="text/javascript" src="js/Graph.js"></script>
<script type="text/javascript" src="js/Editor.js"></script>
<script type="text/javascript" src="sanitizer/sanitizer.min.js"></script>
<script type="text/javascript" src="js/EditorUi.js"></script>
<script type="text/javascript" src="js/Actions.js"></script>
<script type="text/javascript" src="js/Menus.js"></script>
<script type="text/javascript" src="js/Sidebar.js"></script>
<script type="text/javascript" src="js/Toolbar.js"></script>
<script type="text/javascript" src="js/Shapes.js"></script>
<script type="text/javascript" src="js/Format.js"></script>
<script type="text/javascript" src="jscolor/jscolor.js"></script>
<script type="text/javascript" src="js/Dialogs.js"></script> -->

<dom-module id="content-process-editor">
    <template>
        <style>
        :host {
            display: block;
        }
        </style>

        <mxgraph-change-handler id="changeHandler"></mxgraph-change-handler>
        <api-gavi-graph id="api"></api-gavi-graph>
        <!-- <api-sharepoint id="api"></api-sharepoint> -->

        <div id="toolbar"></div>
        <div id="graphEditor" class="geEditor"></div>

    </template>
    <script>
    (function() {
        'use strict';

        Polymer({
            is: 'content-process-editor',
            behaviors: [ReduxBehavior],
            properties: {
                identityNodeId: {
                    type: Number,
                    value: 0,
                    notify: true
                },

                versionValidityDate: {
                    type: Number,
                    value: undefined,
                    notify: true
                },

                nodeData: {
                    type: Object,
                    statePath: 'nodeData'
                },

                children2: {
                    type: Object,
                    statePath: 'children'
                }
            },

            actions: {
                loadChildrenAction: function(children) {
                    return {
                        type: 'LOAD_CHILDREN',
                        children: children
                    }
                }
            },

            observers: [
                '_updateChildren(children2)'
              ],

            ready: function() {
                this.createGraph();
            },

            createGraph: function() {
                var polymerThis = this,
                    currentItemId = this.nodeData.identityNode.properties.uuid, 
                    authorId = this.nodeData.authorNode.properties.uuid,
                    changeHandler = this.$.changeHandler;

                // Main
                var container = this.$.graphEditor;

                //var editorUi = new EditorUi(new Editor(urlParams['chrome'] == '0', themes), container);
                //var graph = editorUi.editor.graph;

                //mxObjectCodec.allowEval = true;
                //var config = mxUtils.load('/polymer/src/mxgraph-import/mxgraph/config/diagrameditor.xml').getDocumentElement();
                //var editor = new mxEditor(node);
                //mxObjectCodec.allowEval = false;

                //editor.setGraphContainer(container);
              
                //var graph = editor.graph;

                this.graph = new mxGraph(container);
                this.model = this.graph.getModel();
                this.editor = new mxEditor();
                //this.editor = new Editor(null, null, null, this.graph);
                //this.editorUi = new EditorUi(this.editor, container);

                // Listen for changes and update the state
                this.graph.model.addListener(mxEvent.CHANGE, function(sender, evt) {
                    if(!polymerThis.updatingChildren) {
                        changeHandler.handleChange(currentItemId, authorId, polymerThis.graph, sender, evt);
                    }
                });

            },

            getChildren: function() {
                var options = {
                    "uuid": this.nodeData.identityNode.properties.uuid,
                    "versionValidityDate": this.versionValidityDate
                };
                var request = this.$.api.getChildren(options),
                    polymerThis = this;
                Promise.all([request.completes])
                    .then(function (requests) {
                        var response = requests[0].response;
                        polymerThis.dispatch('loadChildrenAction', response);
                        // do whatever you want from here...
                        // console.log(response);
                    });
            },

            _updateChildren: function() {
                var polymerThis = this;

                // Gets the default parent for inserting new cells. This
                // is normally the first child of the root (ie. layer 0).
                var parent = this.graph.getDefaultParent();
                // Adds cells to the model in a single step
                polymerThis.updatingChildren = true;
                this.model.beginUpdate();
                try {
                    var childCells = polymerThis.graph.getChildCells(parent, true, true);
                    if(childCells.length > 0) {
                        polymerThis.graph.removeCells(polymerThis.graph.getChildCells(parent, true, true));
                    }
                    for (var i = 0; i < polymerThis.children2.length; i++) {
                        var child = polymerThis.children2[i],
                            contentType = child.identityNode.properties.contentType,
                            customAttributes = child.versionNode.properties,
                            childGeometry = JSON.parse(customAttributes.mxGeometry),
                            geometry = new mxGeometry(childGeometry.x, childGeometry.y, childGeometry.width, childGeometry.height),
                            cell;

                        customAttributes['label'] = customAttributes.title || '';
                        geometry['TRANSLATE_CONTROL_POINTS'] = childGeometry.TRANSLATE_CONTROL_POINTS;
                        geometry['alternateBounds'] = childGeometry.alternateBounds;
                        geometry['sourcePoint'] = childGeometry.sourcePoint;
                        geometry['targetPoint'] = childGeometry.targetPoint;
                        geometry['points'] = childGeometry.points;
                        geometry['offset'] = childGeometry.offset;
                        geometry['relative'] = childGeometry.relative;

                        var doc = mxUtils.createXmlDocument();
                        var node = doc.createElement(contentType);
                        node.setAttribute('label', customAttributes.title);
                        for (var key in customAttributes) {
                            if (customAttributes.hasOwnProperty(key)) {
                               node.setAttribute(key, customAttributes[key]);
                            }
                        }

                        if(customAttributes.mxVertex === true) {
                            cell = polymerThis.graph.insertVertex(parent, null, node, 10, 10, 40, 20, customAttributes.mxStyle);
                        } else {
                            var source = polymerThis.model.getCell(customAttributes.mxSource),
                                target = polymerThis.model.getCell(customAttributes.mxTarget);
                            cell = polymerThis.graph.insertEdge(parent, null, node, source, target, customAttributes.mxStyle);
                        }

                        cell.setGeometry(geometry);
                        //console.log(cell);
                    };

                    polymerThis.graph.refresh();
                    
                } finally {
                   // Updates the display
                   polymerThis.model.endUpdate();
                }
                polymerThis.updatingChildren = false;
            }

        });
    })();
    </script>
</dom-module>
