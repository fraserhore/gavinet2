<link rel="import" href="/polymer/bower_components/polymer/polymer.html">
<link rel="import" href="/polymer/bower_components/polymer-redux/polymer-redux.html">
<link rel="import" href="/polymer/api-gavi-graph.html">

<dom-module id="redux-store">
    <template>
        <api-gavi-graph id="api"></api-gavi-graph>
        <!-- <api-sharepoint id="api"></api-sharepoint> -->
    </template>
    <script>
        Polymer({
          is: 'redux-store'
        });
    </script>
</dom-module>

<script>
    const initialState = {
        friends: ['Rod', 'Shelby'],
        overrides: []
    };

    const reducer = (state, action) => {
        if(!state) return initialState;
        switch (action.type) {
            case 'ADD_FRIEND' : 
                const friends = state.friends.slice(0);
                friends.push(action.friend);
                return Object.assign({}, state, {friends: friends});

            case 'SIGN_UP_STARTED':
                return Object.assign({}, state, { loading: true });

            case 'GET_NODE_DATA_STARTED':
                return Object.assign({}, state, { loading: true });

            case 'LOAD_NODE_DATA' :
                return Object.assign({}, state, {nodeData: action.nodeData});

            case 'LOAD_OVERRIDES' :
                return Object.assign({}, state, {overrides: action.overrides});

            case 'LOAD_CHILDREN' :
                return Object.assign({}, state, {children: action.children});

            case 'UPDATE_VERSION_NAME' :
                return Object.assign({}, state, {versionName: action.versionName});
        }
    };

    const store = Redux.createStore(
        reducer,
        Redux.applyMiddleware(ReduxThunk.default)
    );
    const ReduxBehavior = PolymerRedux(store);
    const AsyncActionsBehavior = {
        actions: {
            signUpWithTimeout: function(username) {
                return function(dispatch) {
                    dispatch({ type: 'SIGN_UP_STARTED' });
                    // Do async task
                    setTimeout(function() {
                        dispatch({
                            type: 'SIGN_UP_COMPLETE',
                            username: username
                        });
                    }, 3000);
                }
            },

            getNodeData: function(options) {
                return function(dispatch) {
                    dispatch({ type: 'GET_NODE_DATA_STARTED'});

                    return this.$.api.getNodeData(options).then(
                        function (requests) {
                            var response = requests[0].response;
                            dispatch({
                                type: 'LOAD_NODE_DATA',
                                nodeData: response
                            });
                            // do whatever you want from here...
                            console.log(response);
                        }
                    );
                
                    // var request = this.$.api.getNodeData(options);

                    // Promise.all([request.completes])
                    //     .then(function (requests) {
                    //         var response = requests[0].response;
                    //         dispatch({
                    //             type: 'LOAD_NODE_DATA',
                    //             nodeData: response
                    //         });
                    //         // do whatever you want from here...
                    //         console.log(response);
                    //     });
                }
            
            }


        }
    };

      

</script>